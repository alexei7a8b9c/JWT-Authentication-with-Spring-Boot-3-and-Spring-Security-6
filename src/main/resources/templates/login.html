<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ - JWT Auth Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .login-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }
        .security-notice {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 1rem;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .password-strength {
            height: 4px;
            margin-top: 5px;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        .strength-weak { background-color: #dc3545; width: 25%; }
        .strength-medium { background-color: #ffc107; width: 50%; }
        .strength-strong { background-color: #28a745; width: 100%; }
        .form-floating:focus-within {
            z-index: 2;
        }
        .input-group .form-control:focus {
            z-index: 3;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" href="/">JWT Auth Demo</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <div class="navbar-nav">
                <a class="nav-link" href="/">–ì–ª–∞–≤–Ω–∞—è</a>
                <a class="nav-link" href="/register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            </div>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0 text-center">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h4>
                </div>
                <div class="card-body p-4">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö -->
                    <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>–û—à–∏–±–∫–∞!</strong> –ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <div th:if="${param.tokenExpired}" class="alert alert-warning alert-dismissible fade show" role="alert">
                        <strong>–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞!</strong> –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <div th:if="${param.logout}" class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>–£—Å–ø–µ—Ö!</strong> –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>

                    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
                    <form th:action="@{/auth/web-signin}" method="post" th:object="${signInRequest}" id="loginForm" novalidate>
                        <!-- CSRF Token -->
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                        <!-- –ü–æ–ª–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                        <div class="form-floating mb-3">
                            <input type="text"
                                   class="form-control"
                                   id="username"
                                   th:field="*{username}"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
                                   required
                                   minlength="5"
                                   maxlength="50"
                                   oninput="sanitizeInput(this)"
                                   autocomplete="username">
                            <label for="username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                            <div class="invalid-feedback" id="usernameFeedback">
                                –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç 5 –¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤
                            </div>
                        </div>

                        <!-- –ü–æ–ª–µ –ø–∞—Ä–æ–ª—è -->
                        <div class="form-floating mb-3">
                            <input type="password"
                                   class="form-control"
                                   id="password"
                                   th:field="*{password}"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                                   required
                                   minlength="8"
                                   maxlength="255"
                                   oninput="sanitizeInput(this); checkPasswordStrength(this.value)"
                                   autocomplete="current-password">
                            <label for="password">–ü–∞—Ä–æ–ª—å</label>
                            <div class="invalid-feedback" id="passwordFeedback">
                                –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤
                            </div>
                            <div class="password-strength" id="passwordStrength"></div>
                        </div>

                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ -->
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe" name="rememberMe">
                            <label class="form-check-label" for="rememberMe">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
                        </div>

                        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                        <button type="submit" class="btn btn-primary w-100 py-2" id="submitBtn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" id="loadingSpinner"></span>
                            <span id="btnText">–í–æ–π—Ç–∏</span>
                        </button>
                    </form>

                    <!-- –°—Å—ã–ª–∫–∏ -->
                    <div class="mt-4 text-center">
                        <p class="mb-2">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="/register" class="text-decoration-none">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a></p>
                        <a href="/forgot-password" class="text-decoration-none small">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
                    </div>

                    <hr class="my-4">

                    <!-- –¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
                    <div class="mt-3">
                        <h6 class="text-muted">–¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</h6>
                        <div class="row small">
                            <div class="col-md-6">
                                <div class="card mb-2">
                                    <div class="card-body py-2">
                                        <strong>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</strong><br>
                                        <code>network_admin / NetAdmin789!</code>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-2">
                                    <div class="card-body py-2">
                                        <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</strong><br>
                                        <code>petrov / petrov123</code>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ -->
                    <div class="security-notice mt-4">
                        <h6 class="mb-2">üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h6>
                        <p class="mb-1 small">–¢–æ–∫–µ–Ω—ã –∑–∞—â–∏—â–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é:</p>
                        <ul class="small mb-0">
                            <li>HTTP-only cookies</li>
                            <li>CSRF –∑–∞—â–∏—Ç–∞</li>
                            <li>Secure flag (HTTPS)</li>
                            <li>SameSite policy</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π -->
<div id="secure-messages"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Ç–æ–∫–µ–Ω–æ–≤ -->
<script>
    class SecureTokenManager {
        constructor() {
            this.accessToken = null;
            this.refreshToken = null;
            this.csrfToken = null;
            this.isInitialized = false;

            this.init();
        }

        init() {
            this.cleanupInsecureStorage();
            this.loadCsrfToken();
            this.isInitialized = true;
            console.log('SecureTokenManager initialized');
        }

        // –û—á–∏—Å—Ç–∫–∞ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
        cleanupInsecureStorage() {
            const storageKeys = ['accessToken', 'refreshToken', 'jwtToken', 'token'];

            storageKeys.forEach(key => {
                localStorage.removeItem(key);
                sessionStorage.removeItem(key);
            });

            this.clearInsecureCookies();
        }

        clearInsecureCookies() {
            const insecureCookies = ['token', 'jwt', 'auth_token'];
            insecureCookies.forEach(cookieName => {
                document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ CSRF —Ç–æ–∫–µ–Ω–∞ –∏–∑ –∫—É–∫–∏
        loadCsrfToken() {
            this.csrfToken = this.getCookie('XSRF-TOKEN');
        }

        // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫—É–∫–∏
        getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                return parts.pop().split(';').shift();
            }
            return null;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        isAuthenticated() {
            return this.csrfToken !== null;
        }

        // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π HTTP –∑–∞–ø—Ä–æ—Å
        async makeSecureRequest(url, options = {}) {
            if (!this.isInitialized) {
                throw new Error('TokenManager not initialized');
            }

            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (this.csrfToken && ['POST', 'PUT', 'DELETE', 'PATCH'].includes(options.method)) {
                headers['X-XSRF-TOKEN'] = this.csrfToken;
            }

            try {
                const response = await fetch(url, {
                    ...options,
                    headers,
                    credentials: 'include'
                });

                if (response.status === 401) {
                    console.log('Token expired, attempting refresh...');
                    const refreshed = await this.refreshTokens();
                    if (refreshed) {
                        return this.makeSecureRequest(url, options);
                    } else {
                        this.handleAuthFailure();
                        throw new Error('Authentication failed');
                    }
                }

                if (response.status === 403) {
                    this.handleForbidden();
                    throw new Error('Access denied');
                }

                return response;

            } catch (error) {
                console.error('Secure request failed:', error);
                throw error;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
        async refreshTokens() {
            try {
                const response = await this.makeSecureRequest('/auth/web-refresh', {
                    method: 'POST'
                });

                if (response.ok) {
                    console.log('Tokens refreshed successfully');
                    return true;
                }
            } catch (error) {
                console.error('Token refresh failed:', error);
            }

            return false;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        handleAuthFailure() {
            this.logout();
            this.showMessage('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'error');

            setTimeout(() => {
                window.location.href = '/login?tokenExpired=true';
            }, 2000);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–µ—Ç–∞ –¥–æ—Å—Ç—É–ø–∞
        handleForbidden() {
            this.showMessage('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', 'error');
        }

        // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π logout
        async logout() {
            try {
                await this.makeSecureRequest('/auth/web-logout', {
                    method: 'POST'
                });
            } catch (error) {
                console.error('Logout request failed:', error);
            } finally {
                this.clearLocalState();
                window.location.href = '/?logout=true';
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        clearLocalState() {
            this.accessToken = null;
            this.refreshToken = null;
            this.csrfToken = null;
            this.cleanupInsecureStorage();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        showMessage(message, type = 'info') {
            let messageContainer = document.getElementById('secure-messages');
            if (!messageContainer) {
                messageContainer = document.createElement('div');
                messageContainer.id = 'secure-messages';
                messageContainer.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10000;
                        max-width: 400px;
                    `;
                document.body.appendChild(messageContainer);
            }

            const messageElement = document.createElement('div');
            messageElement.style.cssText = `
                    padding: 12px 16px;
                    margin-bottom: 10px;
                    border-radius: 4px;
                    color: white;
                    font-family: Arial, sans-serif;
                    font-size: 14px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    animation: slideIn 0.3s ease-out;
                `;

            const styles = {
                error: 'background-color: #dc3545;',
                success: 'background-color: #28a745;',
                info: 'background-color: #17a2b8;',
                warning: 'background-color: #ffc107; color: #212529;'
            };

            messageElement.style.cssText += styles[type] || styles.info;
            messageElement.textContent = message;
            messageContainer.appendChild(messageElement);

            setTimeout(() => {
                if (messageElement.parentNode) {
                    messageElement.parentNode.removeChild(messageElement);
                }
            }, 5000);
        }

        // –ó–∞—â–∏—Ç–∞ –æ—Ç XSS - —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –≤–≤–æ–¥–∞
        sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ URL
        isSafeUrl(url) {
            try {
                const parsedUrl = new URL(url, window.location.origin);
                return parsedUrl.origin === window.location.origin;
            } catch {
                return false;
            }
        }
    }

    // CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
    const style = document.createElement('style');
    style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
    document.head.appendChild(style);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤
    let tokenManager;

    document.addEventListener('DOMContentLoaded', function() {
        tokenManager = new SecureTokenManager();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Bootstrap –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        initFormValidation();

        // –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—Å—Ç–∞–≤–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ –≤ —Ñ–æ—Ä–º—ã
        document.addEventListener('submit', function(e) {
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                const tokenInputs = form.querySelectorAll('input[type="hidden"][name*="token"], input[type="hidden"][name*="Token"]');
                tokenInputs.forEach(input => {
                    if (!input.name.includes('_csrf')) {
                        input.remove();
                    }
                });
            });
        });
    });

    // –§—É–Ω–∫—Ü–∏—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏ –≤–≤–æ–¥–∞
    function sanitizeInput(inputElement) {
        const originalValue = inputElement.value;
        const sanitizedValue = tokenManager.sanitizeInput(originalValue);
        if (originalValue !== sanitizedValue) {
            inputElement.value = sanitizedValue;
            tokenManager.showMessage('–í–≤–æ–¥ –±—ã–ª –æ—á–∏—â–µ–Ω –æ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤', 'warning');
        }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–ª—ã –ø–∞—Ä–æ–ª—è
    function checkPasswordStrength(password) {
        const strengthBar = document.getElementById('passwordStrength');
        if (!password) {
            strengthBar.className = 'password-strength';
            strengthBar.style.width = '0%';
            return;
        }

        let strength = 0;

        // –î–ª–∏–Ω–∞ –ø–∞—Ä–æ–ª—è
        if (password.length >= 8) strength += 25;
        if (password.length >= 12) strength += 15;

        // –ù–∞–ª–∏—á–∏–µ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–∏–º–≤–æ–ª–æ–≤
        if (/[a-z]/.test(password)) strength += 15;
        if (/[A-Z]/.test(password)) strength += 15;
        if (/[0-9]/.test(password)) strength += 15;
        if (/[^a-zA-Z0-9]/.test(password)) strength += 15;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
        strengthBar.style.width = Math.min(strength, 100) + '%';

        if (strength < 50) {
            strengthBar.className = 'password-strength strength-weak';
        } else if (strength < 80) {
            strengthBar.className = 'password-strength strength-medium';
        } else {
            strengthBar.className = 'password-strength strength-strong';
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã
    function initFormValidation() {
        const form = document.getElementById('loginForm');
        const username = document.getElementById('username');
        const password = document.getElementById('password');
        const submitBtn = document.getElementById('submitBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const btnText = document.getElementById('btnText');

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        username.addEventListener('input', function() {
            validateField(this, 5, 50);
        });

        password.addEventListener('input', function() {
            validateField(this, 8, 255);
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            if (validateForm()) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                loadingSpinner.classList.remove('d-none');
                btnText.textContent = '–í—Ö–æ–¥...';
                submitBtn.disabled = true;

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
                this.submit();
            } else {
                tokenManager.showMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ', 'error');
            }
        });

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—è
        function validateField(field, minLength, maxLength) {
            const value = field.value.trim();
            const isValid = value.length >= minLength && value.length <= maxLength;

            if (isValid) {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
            } else {
                field.classList.remove('is-valid');
                field.classList.add('is-invalid');
            }

            return isValid;
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ–π —Ñ–æ—Ä–º—ã
        function validateForm() {
            const isUsernameValid = validateField(username, 5, 50);
            const isPasswordValid = validateField(password, 8, 255);

            return isUsernameValid && isPasswordValid;
        }
    }

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –∫—Ä–∞–∂–∏ —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ console.log
    if (typeof console !== 'undefined') {
        const originalLog = console.log;
        console.log = function(...args) {
            const filteredArgs = args.map(arg => {
                if (typeof arg === 'string' && (arg.includes('Bearer ') || arg.length > 100)) {
                    return '[SECURE TOKEN HIDDEN]';
                }
                return arg;
            });
            originalLog.apply(console, filteredArgs);
        };
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
    window.addEventListener('beforeunload', function() {
        if (tokenManager) {
            tokenManager.cleanupInsecureStorage();
        }
    });

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä–æ–ª—è
    document.getElementById('password').addEventListener('copy', function(e) {
        tokenManager.showMessage('–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª—è –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏', 'warning');
    });

    // –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—Å—Ç–∞–≤–∫–∏ –≤ –ø–æ–ª—è –≤–≤–æ–¥–∞
    document.getElementById('username').addEventListener('paste', function(e) {
        setTimeout(() => sanitizeInput(this), 10);
    });

    document.getElementById('password').addEventListener('paste', function(e) {
        setTimeout(() => sanitizeInput(this), 10);
    });
</script>
</body>
</html>